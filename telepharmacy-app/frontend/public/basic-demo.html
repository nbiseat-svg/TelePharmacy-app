<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Basic Telepharmacy Demo</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2c3e50;
            text-align: center;
        }
        .section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .section h2 {
            margin-top: 0;
            color: #3498db;
        }
        button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #2980b9;
        }
        button.secondary {
            background-color: #95a5a6;
        }
        button.secondary:hover {
            background-color: #7f8c8d;
        }
        button.danger {
            background-color: #e74c3c;
        }
        button.danger:hover {
            background-color: #c0392b;
        }
        input, select, textarea {
            padding: 8px;
            margin: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: calc(100% - 10px);
        }
        .result {
            background-color: #ecf0f1;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
            white-space: pre-wrap;
        }
        .error {
            background-color: #e74c3c;
            color: white;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
        }
        .success {
            background-color: #2ecc71;
            color: white;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
        }
        .warning {
            background-color: #f39c12;
            color: white;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
        }
        .flex-row {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        .flex-row > * {
            flex: 1;
            min-width: 200px;
        }
        .hidden {
            display: none;
        }
        .medication-card {
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
            margin: 10px 0;
            background-color: #fff;
        }
        .medication-card h3 {
            margin-top: 0;
            color: #2c3e50;
        }
        .tabs {
            display: flex;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .tab {
            padding: 10px 20px;
            background-color: #ecf0f1;
            cursor: pointer;
            border: 1px solid #ddd;
            border-bottom: none;
            flex: 1;
            text-align: center;
            min-width: 100px;
        }
        .tab.active {
            background-color: #3498db;
            color: white;
        }
        .tab-content {
            border: 1px solid #ddd;
            padding: 20px;
        }
        .cart-item {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            border-bottom: 1px solid #eee;
        }
        .cart-total {
            text-align: right;
            font-weight: bold;
            font-size: 1.2em;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Basic Telepharmacy Demo</h1>
        
        <div class="tabs">
            <div class="tab active" onclick="switchTab('home')">Home</div>
            <div class="tab" onclick="switchTab('medications')">Medications</div>
            <div class="tab" onclick="switchTab('auth')">Auth</div>
            <div class="tab" onclick="switchTab('pharmacy')">Pharmacy</div>
            <div class="tab" onclick="switchTab('cart')">Cart</div>
            <div class="tab" onclick="switchTab('orders')">Orders</div>
            <div class="tab" onclick="switchTab('prescriptions')">Prescriptions</div>
        </div>
        
        <div id="home" class="tab-content">
            <h2>Welcome to TelePharmacy</h2>
            <p>This is a basic demo of a telepharmacy system with core functionality.</p>
            <div id="connection-status"></div>
            <div class="flex-row">
                <div class="medication-card">
                    <h3>Medication Catalog</h3>
                    <p>Browse our complete catalog of medications</p>
                    <button onclick="switchTab('medications')">View Medications</button>
                </div>
                <div class="medication-card">
                    <h3>Find Pharmacy</h3>
                    <p>Locate pharmacies with specific medications</p>
                    <button onclick="switchTab('pharmacy')">Search Pharmacies</button>
                </div>
                <div class="medication-card">
                    <h3>Shopping Cart</h3>
                    <p>Manage your medication orders</p>
                    <button onclick="switchTab('cart')">View Cart</button>
                </div>
            </div>
        </div>
        
        <div id="medications" class="tab-content hidden">
            <h2>Medication Catalog</h2>
            <button onclick="loadMedications()">Load Medications</button>
            <div id="medications-result"></div>
        </div>
        
        <div id="auth" class="tab-content hidden">
            <h2>User Authentication</h2>
            <div class="flex-row">
                <div>
                    <h3>Login</h3>
                    <input type="text" id="login-username" placeholder="Username">
                    <input type="password" id="login-password" placeholder="Password">
                    <button onclick="login()">Login</button>
                </div>
                <div>
                    <h3>Register</h3>
                    <input type="text" id="register-username" placeholder="Username">
                    <input type="password" id="register-password" placeholder="Password">
                    <select id="register-role">
                        <option value="patient">Patient</option>
                        <option value="pharmacist">Pharmacist</option>
                    </select>
                    <button onclick="register()">Register</button>
                </div>
            </div>
            <div id="auth-result"></div>
        </div>
        
        <div id="pharmacy" class="tab-content hidden">
            <h2>Search Pharmacy</h2>
            <input type="text" id="medication-name" placeholder="Medication Name">
            <button onclick="findPharmacy()">Find Pharmacy</button>
            <div id="pharmacy-result"></div>
        </div>
        
        <div id="cart" class="tab-content hidden">
            <h2>Shopping Cart</h2>
            <div class="flex-row">
                <div>
                    <button onclick="loadCart()">Load Cart</button>
                    <button class="secondary" onclick="clearCart()">Clear Cart</button>
                    <button onclick="checkout()">Checkout</button>
                </div>
            </div>
            <div id="cart-result"></div>
        </div>
        
        <div id="orders" class="tab-content hidden">
            <h2>Place Order</h2>
            <div class="flex-row">
                <div>
                    <input type="text" id="medication-id" placeholder="Medication ID">
                    <input type="number" id="quantity" placeholder="Quantity" value="1">
                    <button onclick="placeOrder()">Place Order</button>
                </div>
                <div>
                    <button onclick="loadOrders()">Load My Orders</button>
                </div>
            </div>
            <div id="order-result"></div>
        </div>
        
        <div id="prescriptions" class="tab-content hidden">
            <h2>Prescription Management</h2>
            <div class="flex-row">
                <div>
                    <h3>Create Prescription</h3>
                    <input type="text" id="prescription-patient-id" placeholder="Patient ID">
                    <input type="text" id="prescription-medication-id" placeholder="Medication ID">
                    <input type="text" id="prescription-dosage" placeholder="Dosage (e.g., 1 tablet twice daily)">
                    <textarea id="prescription-instructions" placeholder="Instructions"></textarea>
                    <button onclick="createPrescription()">Create Prescription</button>
                </div>
                <div>
                    <h3>View Prescriptions</h3>
                    <button onclick="loadPrescriptions()">Load Prescriptions</button>
                </div>
            </div>
            <div id="prescription-result"></div>
        </div>
    </div>

    <script>
        // Base URL for API calls
        const API_BASE = '/api';
        
        // Display result in a div
        function displayResult(elementId, data, isError = false) {
            const element = document.getElementById(elementId);
            if (isError) {
                element.innerHTML = `<div class="error">${JSON.stringify(data, null, 2)}</div>`;
            } else {
                element.innerHTML = `<div class="result">${JSON.stringify(data, null, 2)}</div>`;
            }
        }
        
        // Switch between tabs
        function switchTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.add('hidden');
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab content
            document.getElementById(tabName).classList.remove('hidden');
            
            // Add active class to clicked tab
            event.target.classList.add('active');
        }
        
        // Get current user ID (from localStorage)
        function getCurrentUserId() {
            const user = localStorage.getItem('user');
            if (user) {
                const userData = JSON.parse(user);
                return userData.id;
            }
            return null;
        }
        
        // Load medications
        function loadMedications() {
            fetch(`${API_BASE}/medications`)
                .then(response => {
                    if (response.ok) {
                        return response.json();
                    } else {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                })
                .then(data => {
                    // Format medications as cards with add to cart button
                    let html = '<h3>Available Medications</h3>';
                    data.forEach(med => {
                        html += `
                            <div class="medication-card">
                                <h3>${med.name}</h3>
                                <p>${med.description}</p>
                                <p><strong>Price:</strong> $${med.price}</p>
                                <p><strong>ID:</strong> ${med.id}</p>
                                <div>
                                    <input type="number" id="qty-${med.id}" value="1" min="1" style="width: 60px;">
                                    <button onclick="addToCart(${med.id})">Add to Cart</button>
                                </div>
                            </div>
                        `;
                    });
                    document.getElementById('medications-result').innerHTML = html;
                })
                .catch(error => {
                    displayResult('medications-result', error.message, true);
                });
        }
        
        // Add to cart
        function addToCart(medicationId) {
            const userId = getCurrentUserId();
            if (!userId) {
                alert('Please login first');
                switchTab('auth');
                return;
            }
            
            const quantityInput = document.getElementById(`qty-${medicationId}`);
            const quantity = quantityInput ? parseInt(quantityInput.value) : 1;
            
            fetch(`${API_BASE}/cart/${userId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ medicationId, quantity })
            })
            .then(response => {
                if (response.ok) {
                    return response.json();
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
            })
            .then(data => {
                alert(`Added ${quantity} of medication ${medicationId} to cart`);
            })
            .catch(error => {
                alert('Error adding to cart: ' + error.message);
            });
        }
        
        // Load cart
        function loadCart() {
            const userId = getCurrentUserId();
            if (!userId) {
                displayResult('cart-result', 'Please login first', true);
                return;
            }
            
            fetch(`${API_BASE}/cart/${userId}`)
                .then(response => {
                    if (response.ok) {
                        return response.json();
                    } else {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                })
                .then(data => {
                    // Format cart items
                    if (data.length === 0) {
                        document.getElementById('cart-result').innerHTML = '<p>Your cart is empty</p>';
                        return;
                    }
                    
                    let html = '<div id="cart-items">';
                    let total = 0;
                    
                    data.forEach(item => {
                        const itemTotal = item.price * item.quantity;
                        total += itemTotal;
                        html += `
                            <div class="cart-item">
                                <div>
                                    <strong>${item.medicationName}</strong><br>
                                    Quantity: ${item.quantity}<br>
                                    Price: $${item.price} each
                                </div>
                                <div>
                                    $${itemTotal.toFixed(2)}<br>
                                    <button class="danger" onclick="removeFromCart(${item.medicationId})">Remove</button>
                                </div>
                            </div>
                        `;
                    });
                    
                    html += `
                        <div class="cart-total">
                            Total: $${total.toFixed(2)}
                        </div>
                    `;
                    
                    html += '</div>';
                    document.getElementById('cart-result').innerHTML = html;
                })
                .catch(error => {
                    displayResult('cart-result', error.message, true);
                });
        }
        
        // Remove from cart
        function removeFromCart(medicationId) {
            const userId = getCurrentUserId();
            if (!userId) {
                alert('Please login first');
                return;
            }
            
            fetch(`${API_BASE}/cart/${userId}/${medicationId}`, {
                method: 'DELETE'
            })
            .then(response => {
                if (response.ok) {
                    return response.json();
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
            })
            .then(data => {
                loadCart(); // Refresh cart display
            })
            .catch(error => {
                alert('Error removing from cart: ' + error.message);
            });
        }
        
        // Clear cart
        function clearCart() {
            const userId = getCurrentUserId();
            if (!userId) {
                alert('Please login first');
                return;
            }
            
            // Simple way to clear cart - just reinitialize it
            fetch(`${API_BASE}/cart/${userId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ medicationId: 1, quantity: 0 }) // This will create an item we can then remove
            })
            .then(response => {
                if (response.ok) {
                    return response.json();
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
            })
            .then(data => {
                // Now clear by removing all items
                const clearPromises = data.map(item => 
                    fetch(`${API_BASE}/cart/${userId}/${item.medicationId}`, {
                        method: 'DELETE'
                    })
                );
                
                Promise.all(clearPromises)
                    .then(() => {
                        loadCart(); // Refresh cart display
                        alert('Cart cleared');
                    })
                    .catch(error => {
                        alert('Error clearing cart: ' + error.message);
                    });
            })
            .catch(error => {
                alert('Error clearing cart: ' + error.message);
            });
        }
        
        // Checkout
        function checkout() {
            const userId = getCurrentUserId();
            if (!userId) {
                alert('Please login first');
                switchTab('auth');
                return;
            }
            
            fetch(`${API_BASE}/cart/${userId}/checkout`, {
                method: 'POST'
            })
            .then(response => {
                if (response.ok) {
                    return response.json();
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
            })
            .then(data => {
                alert('Checkout successful! Orders created.');
                loadCart(); // Refresh cart display
                switchTab('orders'); // Switch to orders tab
            })
            .catch(error => {
                alert('Error during checkout: ' + error.message);
            });
        }
        
        // User login
        function login() {
            const username = document.getElementById('login-username').value;
            const password = document.getElementById('login-password').value;
            
            fetch(`${API_BASE}/auth/login`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ username, password })
            })
            .then(response => {
                if (response.ok) {
                    return response.json();
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
            })
            .then(data => {
                displayResult('auth-result', data);
                // Store token for future requests
                if (data.token) {
                    localStorage.setItem('token', data.token);
                    localStorage.setItem('user', JSON.stringify(data.user));
                }
            })
            .catch(error => {
                displayResult('auth-result', error.message, true);
            });
        }
        
        // User registration
        function register() {
            const username = document.getElementById('register-username').value;
            const password = document.getElementById('register-password').value;
            const role = document.getElementById('register-role').value;
            
            fetch(`${API_BASE}/auth/register`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ username, password, role })
            })
            .then(response => {
                if (response.ok) {
                    return response.json();
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
            })
            .then(data => {
                displayResult('auth-result', data);
            })
            .catch(error => {
                displayResult('auth-result', error.message, true);
            });
        }
        
        // Find pharmacy with medication
        function findPharmacy() {
            const medicationName = document.getElementById('medication-name').value;
            
            fetch(`${API_BASE}/pharmacies/search?medication=${encodeURIComponent(medicationName)}`)
                .then(response => {
                    if (response.ok) {
                        return response.json();
                    } else {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                })
                .then(data => {
                    // Format pharmacy results
                    let html = `<h3>Pharmacies with ${data.medication.name}</h3>`;
                    data.pharmacies.forEach(pharmacy => {
                        html += `
                            <div class="medication-card">
                                <h3>${pharmacy.name}</h3>
                                <p><strong>Location:</strong> ${pharmacy.location}</p>
                                <p><strong>ID:</strong> ${pharmacy.id}</p>
                            </div>
                        `;
                    });
                    document.getElementById('pharmacy-result').innerHTML = html;
                })
                .catch(error => {
                    displayResult('pharmacy-result', error.message, true);
                });
        }
        
        // Place order
        function placeOrder() {
            const medicationId = document.getElementById('medication-id').value;
            const quantity = document.getElementById('quantity').value;
            const token = localStorage.getItem('token');
            
            if (!token) {
                displayResult('order-result', 'Please login first', true);
                switchTab('auth');
                return;
            }
            
            fetch(`${API_BASE}/orders`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({ 
                    medicationId, 
                    quantity: parseInt(quantity),
                    status: 'pending'
                })
            })
            .then(response => {
                if (response.ok) {
                    return response.json();
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
            })
            .then(data => {
                displayResult('order-result', data);
            })
            .catch(error => {
                displayResult('order-result', error.message, true);
            });
        }
        
        // Load orders
        function loadOrders() {
            const token = localStorage.getItem('token');
            
            if (!token) {
                displayResult('order-result', 'Please login first', true);
                switchTab('auth');
                return;
            }
            
            fetch(`${API_BASE}/orders`, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            })
            .then(response => {
                if (response.ok) {
                    return response.json();
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
            })
            .then(data => {
                // Format orders
                let html = '<h3>My Orders</h3>';
                if (data.length === 0) {
                    html += '<p>No orders found</p>';
                } else {
                    data.forEach(order => {
                        html += `
                            <div class="medication-card">
                                <h3>Order #${order.id}</h3>
                                <p><strong>Status:</strong> ${order.status}</p>
                                <p><strong>Quantity:</strong> ${order.quantity}</p>
                                <p><strong>Total:</strong> $${order.total}</p>
                                <p><strong>Created:</strong> ${new Date(order.createdAt).toLocaleString()}</p>
                            </div>
                        `;
                    });
                }
                document.getElementById('order-result').innerHTML = html;
            })
            .catch(error => {
                displayResult('order-result', error.message, true);
            });
        }
        
        // Create prescription
        function createPrescription() {
            const patientId = document.getElementById('prescription-patient-id').value;
            const medicationId = document.getElementById('prescription-medication-id').value;
            const dosage = document.getElementById('prescription-dosage').value;
            const instructions = document.getElementById('prescription-instructions').value;
            const token = localStorage.getItem('token');
            
            if (!token) {
                displayResult('prescription-result', 'Please login first', true);
                switchTab('auth');
                return;
            }
            
            fetch(`${API_BASE}/prescriptions`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({ 
                    patientId: parseInt(patientId),
                    medicationId: parseInt(medicationId),
                    dosage,
                    instructions
                })
            })
            .then(response => {
                if (response.ok) {
                    return response.json();
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
            })
            .then(data => {
                displayResult('prescription-result', data);
            })
            .catch(error => {
                displayResult('prescription-result', error.message, true);
            });
        }
        
        // Load prescriptions
        function loadPrescriptions() {
            const token = localStorage.getItem('token');
            
            if (!token) {
                displayResult('prescription-result', 'Please login first', true);
                switchTab('auth');
                return;
            }
            
            fetch(`${API_BASE}/prescriptions`, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            })
            .then(response => {
                if (response.ok) {
                    return response.json();
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
            })
            .then(data => {
                // Format prescriptions
                let html = '<h3>Prescriptions</h3>';
                if (data.length === 0) {
                    html += '<p>No prescriptions found</p>';
                } else {
                    data.forEach(prescription => {
                        html += `
                            <div class="medication-card">
                                <h3>Prescription #${prescription.id}</h3>
                                <p><strong>Medication:</strong> ${prescription.medicationName}</p>
                                <p><strong>Status:</strong> ${prescription.status}</p>
                                <p><strong>Dosage:</strong> ${prescription.dosage}</p>
                                <p><strong>Instructions:</strong> ${prescription.instructions}</p>
                                <p><strong>Created:</strong> ${new Date(prescription.createdAt).toLocaleString()}</p>
                            </div>
                        `;
                    });
                }
                document.getElementById('prescription-result').innerHTML = html;
            })
            .catch(error => {
                displayResult('prescription-result', error.message, true);
            });
        }
        
        // Test connection on page load
        window.onload = function() {
            const statusDiv = document.getElementById('connection-status');
            
            fetch(`${API_BASE}/test`)
                .then(response => {
                    if (response.ok) {
                        statusDiv.innerHTML = '<div class="success">Backend connection successful!</div>';
                    } else {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                })
                .catch(error => {
                    statusDiv.innerHTML = `<div class="error">Backend connection failed: ${error.message}</div>`;
                });
                
            // Set default values for testing
            document.getElementById('login-username').value = 'patient1';
            document.getElementById('login-password').value = 'password123';
        };
    </script>
</body>
</html>